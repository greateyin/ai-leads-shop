// Prisma Schema for AIsell
// 資料庫: PostgreSQL
// 版本: Prisma 6.2+
//
// 主鍵策略: UUIDv7 (RFC 9562)
// - 時間排序: 新資料附加到 B-tree 索引末端，效能優異
// - 全域唯一: 適合分散式系統
// - 原生支援: PostgreSQL uuid 類型
// - 生成方式: 應用層使用 lib/id.ts 的 generateId() 函式

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// 租戶與使用者
// ===========================================

/// 租戶 - 對應一個商店群組或品牌
model Tenant {
  id        String       @id @db.Uuid
  name      String
  subdomain String       @unique
  plan      Plan         @default(SEED)
  status    TenantStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Relations
  users                      User[]
  userTenants                UserTenant[]
  shops                      Shop[]
  products                   Product[]
  productCategories          ProductCategory[]
  productCategoryAssignments ProductCategoryAssignment[]
  productVariants            ProductVariant[]
  productAssets              ProductAsset[]
  carts                      Cart[]
  cartItems                  CartItem[]
  orders                     Order[]
  orderItems                 OrderItem[]
  addresses                  Address[]
  payments                   Payment[]
  paymentProviders           PaymentProvider[]
  paymentNotifications       PaymentNotification[]
  paymentRefunds             PaymentRefund[]
  shippingProviders          ShippingProvider[]
  shippingMethods            ShippingMethod[]
  shippingOrders             ShippingOrder[]
  blogPosts                  BlogPost[]
  blogCategories             BlogCategory[]
  blogTags                   BlogTag[]
  blogCategoryAssignments    BlogCategoryAssignment[]
  blogTagAssignments         BlogTagAssignment[]
  aiInteractions             AiInteraction[]
  aiAttributions             AiAttribution[]
  analyticsEvents            AnalyticsEvent[]
  billingAccount             TenantBillingAccount?
  invoices                   TenantInvoice[]
  usageMetrics               TenantUsageMetric[]
  apiLimits                  TenantApiLimit[]
  auditLogs                  AuditLog[]
  featureFlags               FeatureFlag[]
  trackingSettings           TrackingSettings?
  tenantInvites              TenantInvite[]
  ucpCheckoutSessions        UcpCheckoutSession[]
  files                      File[]

  @@map("tenants")
}

/// 使用者
model User {
  id            String       @id @db.Uuid
  tenantId      String       @db.Uuid // Required per spec 3.1
  name          String?
  email         String       @unique
  emailVerified DateTime?
  passwordHash  String?
  provider      AuthProvider @default(CREDENTIALS)
  role          UserRole     @default(CUSTOMER)
  avatarUrl     String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userTenants    UserTenant[]
  shops          Shop[]
  orders         Order[]
  carts          Cart[]
  addresses      Address[]
  blogPosts      BlogPost[]
  aiInteractions AiInteraction[]
  accounts       Account[]
  sessions       Session[]
  auditLogs      AuditLog[]
  resetTokens    ResetToken[]
  tenantInvites  TenantInvite[]  @relation("InvitedBy")
  uploadedFiles  File[]

  @@index([tenantId])
  @@map("users")
}

/// 使用者-租戶關聯 (支援一個用戶屬於多個租戶)
model UserTenant {
  id        String           @id @db.Uuid
  userId    String           @db.Uuid
  tenantId  String           @db.Uuid
  role      UserRole         @default(STAFF)
  status    UserTenantStatus @default(ACTIVE)
  isDefault Boolean          @default(false)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@map("user_tenants")
}

/// 用戶租戶狀態
enum UserTenantStatus {
  ACTIVE
  SUSPENDED
}

/// 租戶邀請
model TenantInvite {
  id         String             @id @db.Uuid
  tenantId   String             @db.Uuid
  email      String
  role       UserRole           @default(STAFF)
  token      String             @unique
  invitedBy  String             @db.Uuid
  status     TenantInviteStatus @default(PENDING)
  expiresAt  DateTime
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  tenant  Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  inviter User   @relation("InvitedBy", fields: [invitedBy], references: [id])

  @@index([tenantId])
  @@index([email])
  @@index([token])
  @@map("tenant_invites")
}

/// 邀請狀態
enum TenantInviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

/// OAuth 帳號 (Auth.js)
model Account {
  id                String  @id @db.Uuid
  userId            String  @db.Uuid
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

/// Session (Auth.js)
model Session {
  id           String   @id @db.Uuid
  sessionToken String   @unique
  userId       String   @db.Uuid
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

/// 驗證 Token (Auth.js)
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

/// 密碼重設 Token
model ResetToken {
  id        String   @id @db.Uuid
  userId    String   @db.Uuid
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reset_tokens")
}

// ===========================================
// 商店
// ===========================================

/// 商店
/// [不可變規則] 每個 Tenant 只能有 1 個 Shop（@@unique([tenantId])）
/// 參考: docs/02_System_Analysis/05_Single_Tenant_Single_Shop.md
model Shop {
  id          String   @id @db.Uuid
  tenantId    String   @unique @db.Uuid /// 單店制：每個 tenant 只能有一家店
  ownerId     String   @db.Uuid
  name        String
  slug        String   @unique
  domain      String?
  description String?
  logoUrl     String?
  currency    String   @default("TWD")
  timezone    String   @default("Asia/Taipei")
  locale      String   @default("zh-TW")
  config      Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  owner    User      @relation(fields: [ownerId], references: [id])
  products Product[]
  orders   Order[]

  @@map("shops")
}

// ===========================================
// 商品
// ===========================================

/// 商品分類
model ProductCategory {
  id          String   @id @db.Uuid
  tenantId    String   @db.Uuid
  parentId    String?  @db.Uuid
  name        String
  slug        String
  description String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant   Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent   ProductCategory?            @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children ProductCategory[]           @relation("CategoryHierarchy")
  products ProductCategoryAssignment[]

  @@unique([tenantId, slug])
  @@map("product_categories")
}

/// 商品
model Product {
  id              String        @id @db.Uuid
  tenantId        String        @db.Uuid
  shopId          String        @db.Uuid
  name            String
  slug            String
  summary         String?
  descriptionMd   String?       @db.Text
  descriptionHtml String?       @db.Text
  price           Decimal       @db.Decimal(12, 2)
  cost            Decimal?      @db.Decimal(12, 2)
  stock           Int           @default(0)
  sku             String?
  status          ProductStatus @default(DRAFT)
  coverImageUrl   String?
  ogTitle         String? /// OpenGraph 標題
  ogDescription   String? /// OpenGraph 描述
  ogImageUrl      String? /// OpenGraph 圖片
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  deletedAt       DateTime? /// 軟刪除時間戳

  // Relations
  tenant     Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  shop       Shop                        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  categories ProductCategoryAssignment[]
  variants   ProductVariant[]
  assets     ProductAsset[]
  orderItems OrderItem[]
  cartItems  CartItem[]

  @@unique([tenantId, slug]) /// 單店制後改以 tenantId 為唯一範圍
  @@unique([tenantId, sku])  /// 單店制後改以 tenantId 為唯一範圍
  @@index([tenantId])
  @@index([status]) // Public product queries
  @@index([deletedAt])
  @@map("products")
}

/// 商品分類關聯
model ProductCategoryAssignment {
  id         String @id @db.Uuid
  tenantId   String @db.Uuid // Added per spec 3.1
  productId  String @db.Uuid
  categoryId String @db.Uuid

  tenant   Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product  Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  category ProductCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@index([tenantId])
  @@map("product_category_assignments")
}

/// 商品變體 (規格)
model ProductVariant {
  id         String   @id @db.Uuid
  tenantId   String   @db.Uuid // Added per spec 3.1
  productId  String   @db.Uuid
  sku        String
  name       String?
  attributes Json?
  price      Decimal  @db.Decimal(12, 2)
  stock      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]
  cartItems  CartItem[]

  @@index([tenantId])
  @@map("product_variants")
}

/// 商品媒體資源
model ProductAsset {
  id        String    @id @db.Uuid
  tenantId  String    @db.Uuid // Added per spec 3.1
  productId String    @db.Uuid
  type      AssetType @default(IMAGE)
  url       String
  altText   String?
  sortOrder Int       @default(0)

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("product_assets")
}

// ===========================================
// 購物車與訂單
// ===========================================

/// 購物車
model Cart {
  id        String   @id @db.Uuid
  tenantId  String   @db.Uuid
  userId    String?  @db.Uuid
  sessionId String?  @db.Uuid
  total     Decimal  @default(0) @db.Decimal(12, 2)
  currency  String   @default("TWD")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items  CartItem[]

  @@map("carts")
}

/// 購物車項目
model CartItem {
  id        String  @id @db.Uuid
  tenantId  String  @db.Uuid // Added per spec 3.1
  cartId    String  @db.Uuid
  productId String  @db.Uuid
  variantId String? @db.Uuid
  quantity  Int     @default(1)

  // Relations
  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cart    Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([cartId, productId, variantId])
  @@index([tenantId])
  @@map("cart_items")
}

/// 訂單
model Order {
  id             String         @id @db.Uuid
  tenantId       String         @db.Uuid
  shopId         String         @db.Uuid
  userId         String?        @db.Uuid
  orderNo        String         @unique
  status         OrderStatus    @default(PENDING)
  currency       String         @default("TWD")
  totalAmount    Decimal        @db.Decimal(12, 2)
  shippingFee    Decimal        @default(0) @db.Decimal(12, 2)
  discountAmount Decimal        @default(0) @db.Decimal(12, 2)
  taxAmount      Decimal        @default(0) @db.Decimal(12, 2)
  paymentStatus  PaymentStatus  @default(PENDING)
  shippingStatus ShippingStatus @default(PENDING)
  metadata       Json?          /// Store guest info (guestEmail, guestPhone, guestName) for guest checkout
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  shop           Shop            @relation(fields: [shopId], references: [id])
  user           User?           @relation(fields: [userId], references: [id])
  items          OrderItem[]
  addresses      Address[]
  payments       Payment[]
  shippingOrders ShippingOrder[]
  aiAttributions AiAttribution[]

  @@index([tenantId])
  @@index([orderNo])
  @@index([status]) // Filter by order status
  @@index([userId]) // User order queries
  @@index([createdAt]) // Time-based queries for reports (spec 3.2)
  @@map("orders")
}

/// 訂單明細
model OrderItem {
  id        String   @id @db.Uuid
  tenantId  String   @db.Uuid // Added per spec 3.1
  orderId   String   @db.Uuid
  productId String   @db.Uuid
  variantId String?  @db.Uuid
  name      String
  sku       String?
  quantity  Int
  unitPrice Decimal  @db.Decimal(12, 2)
  discount  Decimal  @default(0) @db.Decimal(12, 2)
  subtotal  Decimal  @db.Decimal(12, 2)
  createdAt DateTime @default(now())

  // Relations
  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([tenantId])
  @@map("order_items")
}

/// 地址
model Address {
  id           String      @id @db.Uuid
  tenantId     String      @db.Uuid
  userId       String?     @db.Uuid // Optional for guest checkout (spec section 3.1: user_id nullable)
  orderId      String?     @db.Uuid
  type         AddressType @default(SHIPPING)
  contactName  String
  phone        String
  country      String      @default("TW")
  state        String?
  city         String
  postalCode   String
  addressLine1 String
  addressLine2 String?
  notes        String?
  createdAt    DateTime    @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: Cascade)
  order  Order? @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@map("addresses")
}

// ===========================================
// UCP (Universal Commerce Protocol)
// ===========================================

/// UCP 結帳 Session
model UcpCheckoutSession {
  id              String              @id @db.Uuid
  tenantId        String              @db.Uuid
  shopId          String              @db.Uuid
  platformId      String              @default("google") // UCP Platform 識別碼
  status          UcpSessionStatus    @default(PENDING)
  cartData        Json                // UCP 購物車資料 (items, subtotal, total)
  shippingAddress Json?               // UCP 格式的寄送地址
  billingAddress  Json?               // UCP 格式的帳單地址
  paymentHandlers Json                // 回傳給平台的付款處理器
  buyerEmail      String?
  metadata        Json?               // 額外的元資料
  orderId         String?             @db.Uuid
  expiresAt       DateTime
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([shopId])
  @@index([expiresAt])
  @@map("ucp_checkout_sessions")
}

/// UCP Session 狀態
enum UcpSessionStatus {
  PENDING
  AWAITING_PAYMENT
  PROCESSING
  COMPLETED
  EXPIRED
  CANCELLED
}

// ===========================================
// 金流
// ===========================================

/// 金流供應商配置
model PaymentProvider {
  id        String              @id @db.Uuid
  tenantId  String              @db.Uuid
  type      PaymentProviderType
  name      String
  config    Json
  isDefault Boolean             @default(false)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@map("payment_providers")
}

/// 付款記錄
model Payment {
  id              String              @id @db.Uuid
  tenantId        String              @db.Uuid
  orderId         String              @db.Uuid
  providerId      String?             @db.Uuid
  provider        PaymentProviderType
  method          PaymentMethod?
  amount          Decimal             @db.Decimal(12, 2)
  currency        String              @default("TWD")
  status          PaymentRecordStatus @default(INITIATED)
  transactionNo   String?
  providerOrderNo String?
  paidAt          DateTime?
  failureReason   String?
  rawResponse     Json?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  tenant          Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order           Order                 @relation(fields: [orderId], references: [id], onDelete: Cascade)
  paymentProvider PaymentProvider?      @relation(fields: [providerId], references: [id])
  notifications   PaymentNotification[]
  refunds         PaymentRefund[]

  @@index([tenantId])
  @@index([orderId])
  @@index([paidAt]) // Time-based queries for reports (spec 3.2)
  @@map("payments")
}

/// 金流通知記錄
model PaymentNotification {
  id         String              @id @db.Uuid
  tenantId   String              @db.Uuid // Added per spec 3.1
  paymentId  String              @db.Uuid
  provider   PaymentProviderType
  payload    Json
  verified   Boolean             @default(false)
  receivedAt DateTime            @default(now())

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("payment_notifications")
}

/// 退款記錄
model PaymentRefund {
  id               String       @id @db.Uuid
  tenantId         String       @db.Uuid // Added per spec 3.1
  paymentId        String       @db.Uuid
  amount           Decimal      @db.Decimal(12, 2)
  currency         String       @default("TWD")
  providerRefundNo String?
  status           RefundStatus @default(PENDING)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("payment_refunds")
}

// ===========================================
// 物流
// ===========================================

/// 物流供應商
model ShippingProvider {
  id        String   @id @db.Uuid
  tenantId  String   @db.Uuid
  name      String
  code      String
  config    Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  shippingMethods ShippingMethod[]
  shippingOrders  ShippingOrder[]

  @@map("shipping_providers")
}

/// 配送方式
model ShippingMethod {
  id            String       @id @db.Uuid
  tenantId      String       @db.Uuid
  providerId    String       @db.Uuid
  name          String
  type          ShippingType @default(HOME)
  baseFee       Decimal      @db.Decimal(12, 2)
  freeThreshold Decimal?     @db.Decimal(12, 2)
  etaDays       Int?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  provider       ShippingProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  shippingOrders ShippingOrder[]

  @@map("shipping_methods")
}

/// 物流訂單
model ShippingOrder {
  id             String              @id @db.Uuid
  tenantId       String              @db.Uuid
  orderId        String              @db.Uuid
  providerId     String              @db.Uuid
  methodId       String              @db.Uuid
  status         ShippingOrderStatus @default(CREATED)
  trackingNumber String?
  labelUrl       String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  // Relations
  tenant   Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order    Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  provider ShippingProvider @relation(fields: [providerId], references: [id])
  method   ShippingMethod   @relation(fields: [methodId], references: [id])

  @@map("shipping_orders")
}

// ===========================================
// 部落格
// ===========================================

/// 部落格文章
model BlogPost {
  id             String         @id @db.Uuid
  tenantId       String         @db.Uuid
  authorId       String         @db.Uuid
  title          String
  slug           String
  contentMdx     String         @db.Text
  summary        String?
  coverImageUrl  String?
  seoTitle       String?
  seoDescription String?
  seoJson        Json?
  ogTitle        String? /// OpenGraph 標題
  ogDescription  String? /// OpenGraph 描述
  ogImageUrl     String? /// OpenGraph 圖片
  status         BlogPostStatus @default(DRAFT)
  publishedAt    DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  tenant     Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  author     User                     @relation(fields: [authorId], references: [id])
  categories BlogCategoryAssignment[]
  tags       BlogTagAssignment[]

  @@unique([tenantId, slug])
  @@map("blog_posts")
}

/// 部落格分類
model BlogCategory {
  id          String   @id @db.Uuid
  tenantId    String   @db.Uuid
  parentId    String?  @db.Uuid
  name        String
  slug        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant   Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent   BlogCategory?            @relation("BlogCategoryHierarchy", fields: [parentId], references: [id])
  children BlogCategory[]           @relation("BlogCategoryHierarchy")
  posts    BlogCategoryAssignment[]

  @@unique([tenantId, slug])
  @@map("blog_categories")
}

/// 部落格標籤
model BlogTag {
  id        String   @id @db.Uuid
  tenantId  String   @db.Uuid
  name      String
  slug      String
  createdAt DateTime @default(now())

  // Relations
  tenant Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  posts  BlogTagAssignment[]

  @@unique([tenantId, slug])
  @@map("blog_tags")
}

/// 文章分類關聯
model BlogCategoryAssignment {
  id         String @id @db.Uuid
  tenantId   String @db.Uuid // Added per spec 3.1
  postId     String @db.Uuid
  categoryId String @db.Uuid

  tenant   Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  post     BlogPost     @relation(fields: [postId], references: [id], onDelete: Cascade)
  category BlogCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([postId, categoryId])
  @@index([tenantId])
  @@map("blog_category_assignments")
}

/// 文章標籤關聯
model BlogTagAssignment {
  id       String @id @db.Uuid
  tenantId String @db.Uuid // Added per spec 3.1
  postId   String @db.Uuid
  tagId    String @db.Uuid

  tenant Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  post   BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag    BlogTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
  @@index([tenantId])
  @@map("blog_tag_assignments")
}

// ===========================================
// AI 服務
// ===========================================

/// AI 互動記錄
model AiInteraction {
  id        String            @id @db.Uuid
  tenantId  String            @db.Uuid
  userId    String            @db.Uuid
  type      AiInteractionType
  prompt    String            @db.Text
  response  String            @db.Text
  model     String
  createdAt DateTime          @default(now())

  // Relations
  tenant       Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user         User            @relation(fields: [userId], references: [id])
  attributions AiAttribution[]

  @@index([tenantId])
  @@map("ai_interactions")
}

// ===========================================
// 分析
// ===========================================

/// 分析事件
model AnalyticsEvent {
  id         String   @id @db.Uuid
  tenantId   String   @db.Uuid
  userId     String?  @db.Uuid
  sessionId  String?  @db.Uuid
  eventName  String
  properties Json?
  createdAt  DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([eventName])
  @@map("analytics_events")
}

// ===========================================
// 多租戶計費與配額
// ===========================================

/// 租戶計費帳戶
model TenantBillingAccount {
  id               String        @id @db.Uuid
  tenantId         String        @unique @db.Uuid
  plan             Plan          @default(SEED)
  billingMethod    BillingMethod @default(CREDIT_CARD)
  nextBillingDate  DateTime?
  status           BillingStatus @default(ACTIVE)
  // 支付供應商資訊
  stripeCustomerId String?       @unique
  billingEmail     String?
  billingAddress   Json?
  taxId            String?
  currency         String        @default("TWD")
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_billing_accounts")
}

/// 租戶發票
model TenantInvoice {
  id              String        @id @db.Uuid
  tenantId        String        @db.Uuid
  invoiceNo       String        @unique
  amount          Decimal       @db.Decimal(12, 2)
  currency        String        @default("TWD")
  status          InvoiceStatus @default(DRAFT)
  periodStart     DateTime
  periodEnd       DateTime
  dueDate         DateTime?
  issuedAt        DateTime? /// 發票開立時間
  paidAt          DateTime?
  invoiceUrl      String?
  stripeInvoiceId String?
  items           Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("tenant_invoices")
}

/// 租戶用量指標
model TenantUsageMetric {
  id          String     @id @db.Uuid
  tenantId    String     @db.Uuid
  metricType  MetricType
  value       Decimal    @default(0) @db.Decimal(20, 2)
  periodStart DateTime
  periodEnd   DateTime
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, metricType, periodStart])
  @@index([tenantId])
  @@map("tenant_usage_metrics")
}

/// 租戶 API/配額限制
model TenantApiLimit {
  id         String      @id @db.Uuid
  tenantId   String      @db.Uuid
  metric     QuotaMetric
  limitValue Decimal     @db.Decimal(20, 2)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, metric])
  @@map("tenant_api_limits")
}

// ===========================================
// AI 歸因追蹤
// ===========================================

/// AI 功能貢獻追蹤
model AiAttribution {
  id              String   @id @db.Uuid
  tenantId        String   @db.Uuid
  aiInteractionId String   @db.Uuid
  orderId         String?  @db.Uuid
  revenue         Decimal? @db.Decimal(12, 2)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  aiInteraction AiInteraction @relation(fields: [aiInteractionId], references: [id], onDelete: Cascade)
  order         Order?        @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([aiInteractionId])
  @@index([orderId])
  @@map("ai_attributions")
}

// ===========================================
// 稽核日誌
// ===========================================

/// 稽核日誌
model AuditLog {
  id         String   @id @db.Uuid
  tenantId   String   @db.Uuid
  userId     String?  @db.Uuid
  action     String
  entityType String
  entityId   String?
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?
  metadata   Json?
  createdAt  DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([action])
  @@map("audit_logs")
}

// ===========================================
// 功能旗標
// ===========================================

/// 功能旗標
model FeatureFlag {
  id          String   @id @db.Uuid
  tenantId    String?  @db.Uuid
  key         String
  enabled     Boolean  @default(false)
  value       Json?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([key])
  @@map("feature_flags")
}

// ===========================================
// 檔案儲存
// ===========================================

/// 檔案 - 統一的檔案儲存模型（支援 PostgreSQL bytea 或外部儲存）
model File {
  id         String         @id @db.Uuid
  tenantId   String         @db.Uuid

  // 檔案元資料
  fileName   String         @db.VarChar(512)
  mimeType   String         @db.VarChar(128)
  fileSize   Int            /// 檔案大小 (bytes)

  // 儲存選項
  data       Bytes?         /// PostgreSQL bytea 二進位資料（外部儲存時為 null）
  blobUrl    String?        /// 外部儲存 URL (R2/S3/Vercel Blob)

  // 實體關聯
  entityType FileEntityType /// 所屬實體類型
  entityId   String?        @db.Uuid /// 關聯的實體 ID
  fieldName  String?        @db.VarChar(64) /// 欄位名稱 (coverImage, asset 等)

  // 稽核
  uploadedBy String?        @db.Uuid
  createdAt  DateTime       @default(now())

  // Relations
  tenant   Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  uploader User?   @relation(fields: [uploadedBy], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([entityType, entityId])
  @@map("files")
}

enum FileEntityType {
  SHOP        /// 商店相關（Logo、Banner）
  PRODUCT     /// 商品圖片/資產
  BLOG        /// 部落格封面/附件
  ORDER       /// 訂單相關（發票、標籤）
  USER        /// 使用者頭像
  SYSTEM      /// 系統檔案
}

/// 系統設定 - 全域設定（非租戶專屬）
model SystemSettings {
  id String @id @default("global") @db.VarChar(32) /// 單例模式，固定使用 "global"

  // 儲存供應商設定
  storageProvider StorageProvider @default(POSTGRES)

  // Vercel Blob
  blobReadWriteToken String?

  // Cloudflare R2
  r2AccountId        String?
  r2AccessKeyId      String?
  r2SecretAccessKey  String?
  r2BucketName       String?
  r2PublicUrl        String? /// 自訂網域或 R2.dev URL

  // AWS S3
  s3Region           String?
  s3AccessKeyId      String?
  s3SecretAccessKey  String?
  s3BucketName       String?
  s3Endpoint         String? /// S3 相容服務的自訂端點

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

enum StorageProvider {
  POSTGRES     /// 儲存於 PostgreSQL bytea
  CLOUDFLARE_R2
  AWS_S3
  VERCEL_BLOB
}

// ===========================================
// 追蹤設定
// ===========================================

/// 追蹤設定 (GA4/Pixel/GTM)
model TrackingSettings {
  id               String   @id @db.Uuid
  tenantId         String   @unique @db.Uuid
  ga4MeasurementId String? /// Google Analytics 4 Measurement ID
  metaPixelId      String? /// Meta (Facebook) Pixel ID
  gtmContainerId   String? /// Google Tag Manager Container ID
  tiktokPixelId    String? /// TikTok Pixel ID
  lineTagId        String? /// LINE Tag ID
  customScripts    Json? /// 自訂追蹤腳本
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tracking_settings")
}

/// 向量嵌入 (用於 RAG)
/// 注意：需要安裝 pgvector 擴展
model Embedding {
  id         String              @id @db.Uuid
  tenantId   String              @db.Uuid
  entityType EmbeddingEntityType
  entityId   String
  content    String
  vector     Unsupported("vector(1536)")?
  metadata   Json?
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  @@unique([tenantId, entityType, entityId])
  @@index([tenantId])
  @@map("embeddings")
}

enum EmbeddingEntityType {
  PRODUCT
  BLOG_POST
  FAQ
}

// ===========================================
// Enums
// ===========================================

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum MetricType {
  API_CALLS
  AI_TOKENS
  STORAGE_MB
  ORDERS_COUNT
  PRODUCTS_COUNT
  BANDWIDTH_MB
}

enum Plan {
  SEED
  GROWTH
  PRO
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
}

enum AuthProvider {
  CREDENTIALS
  GOOGLE
  FACEBOOK
  LINE
  APPLE
}

enum UserRole {
  OWNER
  ADMIN
  STAFF
  VIEWER
  CUSTOMER
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum AssetType {
  IMAGE
  VIDEO
  PDF
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  COMPLETED
  CANCELLED
  REFUNDING
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum ShippingStatus {
  PENDING
  PREPARING
  DELIVERING
  DELIVERED
  RETURNED
}

enum PaymentProviderType {
  ECPAY
  NEWEBPAY
  STRIPE
  PAYPAL
  CASH
}

enum PaymentMethod {
  CREDIT_CARD
  ATM
  CVS
  LINE_PAY
  APPLE_PAY
  GOOGLE_PAY
}

enum PaymentRecordStatus {
  INITIATED
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum RefundStatus {
  PENDING
  REFUNDED
  FAILED
}

enum ShippingType {
  HOME
  CVS
  PICKUP
}

enum ShippingOrderStatus {
  CREATED
  AWAITING_PICKUP
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

enum AddressType {
  BILLING
  SHIPPING
  PICKUP
  STORE
}

enum BlogPostStatus {
  DRAFT
  PUBLISHED
}

enum AiInteractionType {
  PRODUCT_DESCRIPTION
  FAQ
  BLOG_SUMMARY
  CHAT
  SEO_CONTENT
  SALES_FORECAST
}

enum BillingMethod {
  CREDIT_CARD
  BANK_TRANSFER
  CRYPTO
}

enum BillingStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum QuotaMetric {
  REQUESTS_PER_MINUTE
  AI_TOKENS_PER_MONTH
  STORAGE_MB
  ORDERS_COUNT
  PRODUCTS_COUNT
}
